/* ========================================
   DONULAND MANAGEMENT SYSTEM - APP.JS ƒå√ÅST 1
   Z√°kladn√≠ konfigurace, glob√°ln√≠ promƒõnn√©, inicializace
   ======================================== */

// ========================================
// GLOB√ÅLN√ç KONFIGURACE
// ========================================

const CONFIG = {
    // API kl√≠ƒçe a URL - ovƒõ≈ôen√© funkƒçn√≠
    SHEETS_URL: 'https://docs.google.com/spreadsheets/d/1LclCz9hb0hlb1D92OyVqk6Cbam7PRK6KgAzGgiGs6iE/edit?usp=sharing',
    WEATHER_API_KEY: 'c2fb0e86623880dc86162892b0fd9c95',
    MAPS_API_KEY: 'AIzaSyBTTA_MKa6FrxKpkcd7c5-d3FnC6FBLVTc',
    
    // Business parametry
    DONUT_PRICE: 50,
    DONUT_COST: 32,
    FRANCHISE_PRICE: 52,
    HOURLY_WAGE: 150,
    WORK_HOURS: 10,
    FUEL_COST: 15,
    
    // Predikƒçn√≠ faktory pro AI
    CATEGORY_FACTORS: {
        'food festival': 0.15,      // 15% konverze
        'veletrh': 0.18,           // 18% konverze (nejlep≈°√≠)
        'koncert': 0.08,           // 8% konverze (nejhor≈°√≠)
        'kulturn√≠ akce': 0.12,     // 12% konverze
        'sportovn√≠': 0.10,         // 10% konverze
        'ostatn√≠': 0.10            // 10% konverze (default)
    },
    
    // Faktory podle mƒõst
    CITY_FACTORS: {
        'praha': 1.3,              // Praha m√° 30% vy≈°≈°√≠ prodej
        'brno': 1.2,               // Brno m√° 20% vy≈°≈°√≠ prodej
        'ostrava': 1.0,            // Ostrava je baseline
        'plze≈à': 0.9,              // Men≈°√≠ mƒõsta maj√≠ ni≈æ≈°√≠ prodej
        'liberec': 0.8,
        'olomouc': 0.85,
        'default': 0.85            // Pro nezn√°m√° mƒõsta
    },
    
    // Faktory podle konkurence
    COMPETITION_FACTORS: {
        1: 1.2,  // Mal√° konkurence = +20%
        2: 1.0,  // St≈ôedn√≠ konkurence = baseline
        3: 0.7   // Velk√° konkurence = -30%
    },
    
    // Limity pro predikci
    MIN_CONVERSION: 0.02,          // Minim√°lnƒõ 2% konverze
    MAX_CONVERSION: 0.40,          // Maxim√°lnƒõ 40% konverze
    MIN_SALES: 20,                 // Minim√°lnƒõ 20 ks prodeje
    
    // Cache nastaven√≠
    WEATHER_CACHE_TIME: 30 * 60 * 1000,  // 30 minut
    DISTANCE_CACHE_TIME: 24 * 60 * 60 * 1000,  // 24 hodin
    
    // Google Sheets sloupce (dle va≈°√≠ struktury)
    SHEETS_COLUMNS: {
        DATE_FROM: 'B',         // Datum od
        DATE_TO: 'C',           // Datum do  
        CITY: 'D',              // Lokalita
        EVENT_NAME: 'E',        // N√°zev akce
        CATEGORY: 'F',          // Kategorie
        SALES: 'M',             // Re√°lnƒõ prod√°no (kl√≠ƒçov√©!)
        VISITORS: 'Q',          // N√°v≈°tƒõvnost
        WEATHER: 'R',           // Poƒças√≠
        COMPETITION: 'W',       // Konkurence (1-3)
        RATING: 'X',            // Hodnocen√≠ (1-5)
        NOTES: 'Y'              // Pozn√°mka
    }
};

// ========================================
// GLOB√ÅLN√ç PROMƒöNN√â A ST√ÅTY
// ========================================

const globalState = {
    // Data a cache
    historicalData: [],
    weatherCache: new Map(),
    distanceCache: new Map(),
    
    // Loading stavy
    isLoading: false,
    isLoadingWeather: false,
    isLoadingPrediction: false,
    
    // Metadata
    lastDataLoad: null,
    dataLoadAttempts: 0,
    
    // UI stavy
    currentSection: 'prediction',
    currentMonth: new Date().getMonth(),
    currentYear: new Date().getFullYear(),
    
    // Formul√°≈ô data
    lastFormData: null,
    lastPrediction: null,
    
    // Chyby a logy
    errors: [],
    debugMode: false
};

// Event emitter pro komunikaci mezi komponenty
const eventBus = {
    events: new Map(),
    
    on(event, callback) {
        if (!this.events.has(event)) {
            this.events.set(event, []);
        }
        this.events.get(event).push(callback);
    },
    
    emit(event, data) {
        if (this.events.has(event)) {
            this.events.get(event).forEach(callback => {
                try {
                    callback(data);
                } catch (error) {
                    console.error(`Error in event ${event}:`, error);
                }
            });
        }
    },
    
    off(event, callback) {
        if (this.events.has(event)) {
            const callbacks = this.events.get(event);
            const index = callbacks.indexOf(callback);
            if (index > -1) {
                callbacks.splice(index, 1);
            }
        }
    }
};

// ========================================
// INICIALIZACE APLIKACE
// ========================================

// Hlavn√≠ inicializace p≈ôi naƒçten√≠ DOM
document.addEventListener('DOMContentLoaded', function() {
    console.log('üç© Donuland Management System - Starting...');
    console.log('üìÖ Current date:', new Date().toLocaleDateString('cs-CZ'));
    
    try {
        // 1. Inicializace z√°kladn√≠ch komponent
        initializeCore();
        
        // 2. Naƒçten√≠ ulo≈æen√Ωch nastaven√≠
        loadSettings();
        
        // 3. Inicializace UI element≈Ø
        initializeUI();
        
        // 4. Setup event listener≈Ø
        setupEventListeners();
        
        // 5. Spu≈°tƒõn√≠ loading sekvence
        startLoadingSequence();
        
        console.log('‚úÖ Application initialized successfully');
        
    } catch (error) {
        console.error('‚ùå Failed to initialize application:', error);
        showNotification('Chyba p≈ôi inicializaci aplikace', 'error');
    }
});

// Inicializace z√°kladn√≠ch komponent
function initializeCore() {
    console.log('üîß Initializing core components...');
    
    // Kontrola po≈æadovan√Ωch HTML element≈Ø
    const requiredElements = [
        'loadingScreen', 'mainApp', 'status', 'predictionResults',
        'eventName', 'category', 'city', 'eventDate', 'visitors',
        'competition', 'eventType', 'businessModel', 'rentType'
    ];
    
    const missingElements = requiredElements.filter(id => !document.getElementById(id));
    
    if (missingElements.length > 0) {
        throw new Error(`Missing required HTML elements: ${missingElements.join(', ')}`);
    }
    
    // Nastaven√≠ v√Ωchoz√≠ch hodnot
    setDefaultFormValues();
    
    // Inicializace cache storage
    initializeCache();
    
    // Setup debug re≈æimu
    if (window.location.search.includes('debug=true')) {
        globalState.debugMode = true;
        console.log('üêõ Debug mode enabled');
    }
}

// Nastaven√≠ v√Ωchoz√≠ch hodnot formul√°≈ôe
function setDefaultFormValues() {
    console.log('üìù Setting default form values...');
    
    // Datum akce - 7 dn√≠ do budoucna
    const nextWeek = new Date();
    nextWeek.setDate(nextWeek.getDate() + 7);
    const eventDateInput = document.getElementById('eventDate');
    if (eventDateInput) {
        eventDateInput.value = nextWeek.toISOString().split('T')[0];
    }
    
    // V√Ωchoz√≠ cena donut
    const priceInput = document.getElementById('price');
    if (priceInput && !priceInput.value) {
        priceInput.value = CONFIG.DONUT_PRICE;
    }
    
    // Nastaven√≠ business parametr≈Ø v nastaven√≠
    const businessParams = [
        { id: 'donutCost', value: CONFIG.DONUT_COST },
        { id: 'franchisePrice', value: CONFIG.FRANCHISE_PRICE },
        { id: 'hourlyWage', value: CONFIG.HOURLY_WAGE },
        { id: 'workHours', value: CONFIG.WORK_HOURS },
        { id: 'fuelCost', value: CONFIG.FUEL_COST }
    ];
    
    businessParams.forEach(param => {
        const element = document.getElementById(param.id);
        if (element && !element.value) {
            element.value = param.value;
        }
    });
    
    // Nastaven√≠ predikƒçn√≠ch faktor≈Ø
    const factors = [
        { id: 'factorFood', value: CONFIG.CATEGORY_FACTORS['food festival'] },
        { id: 'factorVeletrh', value: CONFIG.CATEGORY_FACTORS['veletrh'] },
        { id: 'factorKoncert', value: CONFIG.CATEGORY_FACTORS['koncert'] },
        { id: 'factorKultura', value: CONFIG.CATEGORY_FACTORS['kulturn√≠ akce'] },
        { id: 'factorSport', value: CONFIG.CATEGORY_FACTORS['sportovn√≠'] },
        { id: 'factorPraha', value: CONFIG.CITY_FACTORS['praha'] },
        { id: 'factorBrno', value: CONFIG.CITY_FACTORS['brno'] },
        { id: 'factorOstrava', value: CONFIG.CITY_FACTORS['ostrava'] },
        { id: 'factorOther', value: CONFIG.CITY_FACTORS['default'] }
    ];
    
    factors.forEach(factor => {
        const element = document.getElementById(factor.id);
        if (element && !element.value) {
            element.value = factor.value;
        }
    });
}

// Inicializace cache syst√©mu
function initializeCache() {
    console.log('üíæ Initializing cache system...');
    
    // Vyƒçi≈°tƒõn√≠ star√Ωch cache dat
    const now = Date.now();
    
    // Kontrola weather cache
    for (const [key, data] of globalState.weatherCache.entries()) {
        if (now - data.timestamp > CONFIG.WEATHER_CACHE_TIME) {
            globalState.weatherCache.delete(key);
        }
    }
    
    // Kontrola distance cache
    for (const [key, data] of globalState.distanceCache.entries()) {
        if (now - data.timestamp > CONFIG.DISTANCE_CACHE_TIME) {
            globalState.distanceCache.delete(key);
        }
    }
    
    console.log(`üíæ Cache initialized - Weather: ${globalState.weatherCache.size}, Distance: ${globalState.distanceCache.size}`);
}

// ========================================
// UI INICIALIZACE
// ========================================

// Inicializace u≈æivatelsk√©ho rozhran√≠
function initializeUI() {
    console.log('üé® Initializing UI components...');
    
    // Inicializace navigace
    initializeNavigation();
    
    // Inicializace formul√°≈ôov√Ωch prvk≈Ø
    initializeFormElements();
    
    // Nastaven√≠ aktu√°ln√≠ho mƒõs√≠ce v kalend√°≈ôi
    updateCurrentMonthDisplay();
    
    // Inicializace status indik√°toru
    updateStatus('offline', 'Syst√©m inicializov√°n');
    
    // Skryt√≠ weather karty (dokud nen√≠ outdoor akce)
    const weatherCard = document.getElementById('weatherCard');
    if (weatherCard) {
        weatherCard.style.display = 'none';
    }
    
    // Skryt√≠ historick√Ωch dat (dokud nejsou naƒçtena)
    const historicalCard = document.getElementById('historicalCard');
    if (historicalCard) {
        historicalCard.style.display = 'none';
    }
    
    console.log('‚úÖ UI components initialized');
}

// Inicializace navigace mezi sekcemi
function initializeNavigation() {
    const navButtons = document.querySelectorAll('.nav-btn');
    
    navButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = button.getAttribute('data-section');
            
            if (sectionId && sectionId !== globalState.currentSection) {
                showSection(sectionId);
                
                // Aktualizace aktivn√≠ho tlaƒç√≠tka
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Ulo≈æen√≠ aktu√°ln√≠ sekce
                globalState.currentSection = sectionId;
                
                // Emit event pro jin√© komponenty
                eventBus.emit('sectionChanged', { section: sectionId });
                
                console.log(`üìç Switched to section: ${sectionId}`);
            }
        });
    });
}

// Zobrazen√≠ konkr√©tn√≠ sekce
function showSection(sectionId) {
    console.log(`üîÑ Showing section: ${sectionId}`);
    
    // Skryt√≠ v≈°ech sekc√≠
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Zobrazen√≠ vybran√© sekce s animac√≠
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
        targetSection.classList.add('fade-in');
        
        // Speci√°ln√≠ akce pro jednotliv√© sekce
        switch (sectionId) {
            case 'calendar':
                initializeCalendar();
                break;
            case 'analytics':
                initializeAnalytics();
                break;
            case 'settings':
                updateDataStatistics();
                break;
        }
    } else {
        console.error(`‚ùå Section not found: ${sectionId}`);
    }
}

// Inicializace formul√°≈ôov√Ωch prvk≈Ø
function initializeFormElements() {
    console.log('üìù Initializing form elements...');
    
    // P≈ôid√°n√≠ change listener≈Ø pro automatickou predikci
    const formElements = [
        'eventName', 'category', 'city', 'eventDate', 'visitors',
        'competition', 'eventType', 'businessModel', 'rentType',
        'fixedRent', 'percentage', 'mixedFixed', 'mixedPercentage', 'price'
    ];
    
    formElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
            element.addEventListener('change', debounce(() => {
                if (validateRequiredFields()) {
                    updatePrediction();
                }
            }, 500));
            
            // P≈ôid√°n√≠ focus/blur efekt≈Ø
            element.addEventListener('focus', () => {
                element.parentElement.classList.add('focused');
            });
            
            element.addEventListener('blur', () => {
                element.parentElement.classList.remove('focused');
            });
        }
    });
    
    // Speci√°ln√≠ handlery pro konkr√©tn√≠ prvky
    const eventTypeSelect = document.getElementById('eventType');
    if (eventTypeSelect) {
        eventTypeSelect.addEventListener('change', updateWeatherCard);
    }
    
    const businessModelSelect = document.getElementById('businessModel');
    if (businessModelSelect) {
        businessModelSelect.addEventListener('change', updateBusinessInfo);
    }
    
    const rentTypeSelect = document.getElementById('rentType');
    if (rentTypeSelect) {
        rentTypeSelect.addEventListener('change', updateRentFields);
    }
    
    const cityInput = document.getElementById('city');
    if (cityInput) {
        cityInput.addEventListener('change', () => {
            updateDistance();
            updateWeather();
        });
    }
    
    const eventDateInput = document.getElementById('eventDate');
    if (eventDateInput) {
        eventDateInput.addEventListener('change', updateWeather);
    }
}

// ========================================
// EVENT LISTENERS SETUP
// ========================================

// Nastaven√≠ glob√°ln√≠ch event listener≈Ø
function setupEventListeners() {
    console.log('üéØ Setting up event listeners...');
    
    // Keyboard shortcuts
    document.addEventListener('keydown', handleKeyboardShortcuts);
    
    // Window resize handler
    window.addEventListener('resize', debounce(handleWindowResize, 250));
    
    // Network status monitoring
    window.addEventListener('online', handleOnlineStatus);
    window.addEventListener('offline', handleOfflineStatus);
    
    // Page visibility changes
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // Before unload warning (pokud jsou neulo≈æen√© zmƒõny)
    window.addEventListener('beforeunload', handleBeforeUnload);
    
    // Click outside modal to close
    document.addEventListener('click', handleModalOutsideClick);
    
    // Error handling
    window.addEventListener('error', handleGlobalError);
    window.addEventListener('unhandledrejection', handleUnhandledRejection);
    
    console.log('‚úÖ Event listeners configured');
}

// Keyboard shortcuts handler
function handleKeyboardShortcuts(e) {
    // Ctrl/Cmd + S - Ulo≈æit predikci
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (globalState.currentSection === 'prediction' && globalState.lastPrediction) {
            savePrediction();
        }
    }
    
    // Ctrl/Cmd + E - Export
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        if (globalState.currentSection === 'prediction' && globalState.lastPrediction) {
            exportPrediction();
        }
    }
    
    // Escape - Zav≈ô√≠t modal
    if (e.key === 'Escape') {
        closeModal();
    }
    
    // Ctrl/Cmd + R - Reload data
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        loadData();
    }
}

// Network status handlers
function handleOnlineStatus() {
    console.log('üåê Network: Online');
    updateStatus('online', 'Online - p≈ôipojeno');
    showNotification('üåê Internetov√© p≈ôipojen√≠ obnoveno', 'success', 3000);
    
    // Zkusit znovu naƒç√≠st data pokud se nezda≈ôilo offline
    if (globalState.historicalData.length === 0) {
        setTimeout(() => loadData(), 1000);
    }
}

function handleOfflineStatus() {
    console.log('üì° Network: Offline');
    updateStatus('offline', 'Offline - bez p≈ôipojen√≠');
    showNotification('üì° Ztraceno internetov√© p≈ôipojen√≠', 'warning', 5000);
}

// Visibility change handler
function handleVisibilityChange() {
    if (document.hidden) {
        console.log('üëÅÔ∏è Page hidden');
    } else {
        console.log('üëÅÔ∏è Page visible');
        
        // Zkontrolovat, zda nejsou data star≈°√≠ ne≈æ 1 hodinu
        if (globalState.lastDataLoad) {
            const hourAgo = Date.now() - (60 * 60 * 1000);
            if (globalState.lastDataLoad < hourAgo) {
                console.log('üìä Data are old, refreshing...');
                loadData();
            }
        }
    }
}

// Before unload handler
function handleBeforeUnload(e) {
    // Pokud jsou neulo≈æen√© zmƒõny v predikci, varovat u≈æivatele
    if (globalState.lastPrediction && !globalState.lastPrediction.saved) {
        const message = 'M√°te neulo≈æenou predikci. Opravdu chcete opustit str√°nku?';
        e.returnValue = message;
        return message;
    }
}

// Modal outside click handler
function handleModalOutsideClick(e) {
    const modal = document.getElementById('eventModal');
    if (modal && modal.style.display === 'flex' && e.target === modal) {
        closeModal();
    }
}

// Global error handlers
function handleGlobalError(e) {
    console.error('üö® Global error:', e.error);
    globalState.errors.push({
        type: 'javascript',
        message: e.error.message,
        stack: e.error.stack,
        timestamp: new Date().toISOString()
    });
    
    if (globalState.debugMode) {
        showNotification(`JS Error: ${e.error.message}`, 'error', 10000);
    }
}

function handleUnhandledRejection(e) {
    console.error('üö® Unhandled promise rejection:', e.reason);
    globalState.errors.push({
        type: 'promise',
        message: e.reason.toString(),
        timestamp: new Date().toISOString()
    });
    
    if (globalState.debugMode) {
        showNotification(`Promise Error: ${e.reason}`, 'error', 10000);
    }
}

// Window resize handler
function handleWindowResize() {
    // Aktualizace layoutu pro kalend√°≈ô a grafy
    if (globalState.currentSection === 'calendar') {
        // P≈ôepoƒç√≠tat kalend√°≈ô pro novou velikost
        updateCalendarLayout();
    }
    
    if (globalState.currentSection === 'analytics') {
        // P≈ôepoƒç√≠tat grafy
        updateChartsLayout();
    }
}

// ========================================
// LOADING SEKVENCE
// ========================================

// Spu≈°tƒõn√≠ loading sekvence
function startLoadingSequence() {
    console.log('‚è≥ Starting loading sequence...');
    
    // Zobrazen√≠ loading screen na 3 sekundy
    setTimeout(() => {
        hideLoadingScreen();
        
        // Po skryt√≠ loading screen automaticky naƒç√≠st data
        setTimeout(() => {
            if (globalState.historicalData.length === 0) {
                loadData().catch(error => {
                    console.warn('‚ö†Ô∏è Automatic data loading failed:', error);
                    showNotification('Automatick√© naƒçten√≠ dat selhalo. Zkuste tlaƒç√≠tko "Naƒç√≠st data".', 'warning', 8000);
                });
            }
        }, 1500);
        
    }, 3000);
}

// Skryt√≠ loading screen
function hideLoadingScreen() {
    console.log('üé¨ Hiding loading screen...');
    
    const loadingScreen = document.getElementById('loadingScreen');
    const mainApp = document.getElementById('mainApp');
    
    if (loadingScreen && mainApp) {
        // Fade out loading screen
        loadingScreen.style.opacity = '0';
        
        setTimeout(() => {
            loadingScreen.style.display = 'none';
            mainApp.style.display = 'block';
            mainApp.classList.add('fade-in');
            
            // Emit event o dokonƒçen√≠ naƒçten√≠
            eventBus.emit('appLoaded', { timestamp: Date.now() });
            
            console.log('‚úÖ App is now visible and ready');
        }, 500);
    }
}

// ========================================
// HELPER FUNKCE
// ========================================

// Debounce funkce pro omezen√≠ poƒçtu vol√°n√≠
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Throttle funkce pro omezen√≠ frekvence vol√°n√≠
function throttle(func, wait) {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, wait);
        }
    };
}

// Validace povinn√Ωch pol√≠
function validateRequiredFields() {
    const requiredFields = [
        'eventName', 'category', 'city', 'eventDate', 'visitors',
        'competition', 'eventType', 'businessModel', 'rentType'
    ];
    
    let allValid = true;
    
    requiredFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            const value = element.value.trim();
            
            if (!value) {
                allValid = false;
                element.classList.add('error');
            } else {
                element.classList.remove('error');
            }
        }
    });
    
    return allValid;
}

// Form√°tov√°n√≠ ƒç√≠sel pro ƒçesk√© prost≈ôed√≠
function formatNumber(number) {
    if (number === null || number === undefined || isNaN(number)) {
        return '0';
    }
    return new Intl.NumberFormat('cs-CZ').format(Math.round(number));
}

// Form√°tov√°n√≠ mƒõny
function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) {
        return '0 Kƒç';
    }
    return new Intl.NumberFormat('cs-CZ', {
        style: 'currency',
        currency: 'CZK',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(Math.round(amount));
}

// Form√°tov√°n√≠ data
function formatDate(date) {
    if (!date) return '';
    
    if (typeof date === 'string') {
        date = new Date(date);
    }
    
    if (isNaN(date.getTime())) {
        return '';
    }
    
    return date.toLocaleDateString('cs-CZ');
}

// Form√°tov√°n√≠ ƒçasu
function formatTime(date) {
    if (!date) return '';
    
    if (typeof date === 'string') {
        date = new Date(date);
    }
    
    if (isNaN(date.getTime())) {
        return '';
    }
    
    return date.toLocaleTimeString('cs-CZ', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

// Escape HTML pro bezpeƒçnost
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Odstranƒõn√≠ diakritiky pro porovn√°v√°n√≠
function removeDiacritics(str) {
    if (!str) return '';
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

// Generov√°n√≠ unik√°tn√≠ho ID
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// Deep clone objektu
function deepClone(obj) {
    if (obj === null || typeof obj !== 'object') return obj;
    if (obj instanceof Date) return new Date(obj);
    if (obj instanceof Array) return obj.map(item => deepClone(item));
    if (typeof obj === 'object') {
        const cloned = {};
        for (const key in obj) {
            if (obj.hasOwnProperty(key)) {
                cloned[key] = deepClone(obj[key]);
            }
        }
        return cloned;
    }
}

// ========================================
// DEBUG A MONITORING
// ========================================

// Debug informace pro v√Ωvoj√°≈ôe
if (typeof window !== 'undefined') {
    window.donulandDebug = {
        // P≈ô√≠stup ke glob√°ln√≠mu stavu
        getState: () => globalState,
        getConfig: () => CONFIG,
        
        // Cache management
        clearCache: () => {
            globalState.weatherCache.clear();
            globalState.distanceCache.clear();
            console.log('üßπ All cache cleared');
        },
        
        // Logs
        getErrors: () => globalState.errors,
        clearErrors: () => {
            globalState.errors = [];
            console.log('üóëÔ∏è Error log cleared');
        },
        
        // Force reload
        forceReload: () => {
            globalState.historicalData = [];
            globalState.lastDataLoad = null;
            loadData();
        },
        
        // Export debug info
        exportDebugInfo: () => {
            const debugInfo = {
                state: globalState,
                config: CONFIG,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            const blob = new Blob([JSON.stringify(debugInfo, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `donuland-debug-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    };
}

// Performance monitoring
const performanceMonitor = {
    marks: new Map(),
    
    start(name) {
        this.marks.set(name, performance.now());
    },
    
    end(name) {
        const start = this.marks.get(name);
        if (start) {
            const duration = performance.now() - start;
            console.log(`‚è±Ô∏è ${name}: ${duration.toFixed(2)}ms`);
            this.marks.delete(name);
            return duration;
        }
        return null;
    }
};

// ========================================
// INICIALIZACE A EXPORT
// ========================================

// Event listener pro inicializaci error handlingu
console.log('‚úÖ Donuland Management System - Core initialized');
console.log('üìö Available debug commands: window.donulandDebug');

// Export funkc√≠ pro pou≈æit√≠ v dal≈°√≠ch ƒç√°stech
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        CONFIG,
        globalState,
        eventBus,
        formatNumber,
        formatCurrency,
        formatDate,
        escapeHtml,
        removeDiacritics,
        debounce,
        throttle
    };
}

// ========================================
// STATUS A NOTIFIKACE SYST√âM
// ========================================

// Aktualizace status indik√°toru
function updateStatus(status, message) {
    const statusEl = document.getElementById('status');
    if (!statusEl) return;
    
    // Odstranƒõn√≠ v≈°ech status t≈ô√≠d
    statusEl.className = 'status';
    statusEl.classList.add(status);
    
    // Aktualizace obsahu
    statusEl.innerHTML = `
        <span class="status-dot"></span>
        <span>${escapeHtml(message)}</span>
    `;
    
    console.log(`üìä Status updated: ${status} - ${message}`);
    
    // Emit event pro jin√© komponenty
    eventBus.emit('statusChanged', { status, message, timestamp: Date.now() });
}

// Syst√©m notifikac√≠
let notificationCounter = 0;

function showNotification(message, type = 'info', duration = 5000) {
    const container = document.getElementById('notifications') || createNotificationContainer();
    
    const notificationId = `notification-${++notificationCounter}`;
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.id = notificationId;
    
    // Ikony podle typu
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };
    
    const icon = icons[type] || icons.info;
    
    notification.innerHTML = `
        <div class="notification-icon">${icon}</div>
        <div class="notification-content">
            <div class="notification-title">${type.toUpperCase()}</div>
            <div class="notification-message">${escapeHtml(message)}</div>
        </div>
        <button class="notification-close" onclick="closeNotification('${notificationId}')">&times;</button>
    `;
    
    container.appendChild(notification);
    
    // Animace zobrazen√≠
    requestAnimationFrame(() => {
        notification.classList.add('show');
    });
    
    // Automatick√© zav≈ôen√≠
    if (duration > 0) {
        setTimeout(() => {
            closeNotification(notificationId);
        }, duration);
    }
    
    console.log(`üì¢ Notification: ${type} - ${message}`);
    
    // Emit event
    eventBus.emit('notificationShown', { type, message, duration });
    
    return notificationId;
}

// Vytvo≈ôen√≠ kontejneru pro notifikace
function createNotificationContainer() {
    const container = document.createElement('div');
    container.id = 'notifications';
    container.className = 'notifications-container';
    document.body.appendChild(container);
    return container;
}

// Zav≈ôen√≠ notifikace
function closeNotification(notificationId) {
    const notification = document.getElementById(notificationId);
    if (notification) {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    }
}

// ========================================
// LOAD BUTTON MANAGEMENT
// ========================================

// Aktualizace load tlaƒç√≠tka
function updateLoadButton(state, customText = null) {
    const loadBtn = document.getElementById('loadBtn');
    const parentButton = loadBtn ? loadBtn.parentElement : null;
    
    if (!loadBtn || !parentButton) return;
    
    switch (state) {
        case 'loading':
            loadBtn.innerHTML = '‚è≥ Naƒç√≠t√°m...';
            parentButton.disabled = true;
            parentButton.classList.add('loading');
            break;
            
        case 'success':
            loadBtn.innerHTML = '‚úÖ Data naƒçtena';
            parentButton.disabled = false;
            parentButton.classList.remove('loading');
            
            // N√°vrat na p≈Øvodn√≠ text po 3 sekund√°ch
            setTimeout(() => {
                if (loadBtn.innerHTML === '‚úÖ Data naƒçtena') {
                    loadBtn.innerHTML = 'üîÑ Naƒç√≠st data';
                }
            }, 3000);
            break;
            
        case 'error':
            loadBtn.innerHTML = '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠';
            parentButton.disabled = false;
            parentButton.classList.remove('loading');
            
            // N√°vrat na p≈Øvodn√≠ text po 4 sekund√°ch
            setTimeout(() => {
                if (loadBtn.innerHTML === '‚ùå Chyba p≈ôi naƒç√≠t√°n√≠') {
                    loadBtn.innerHTML = 'üîÑ Naƒç√≠st data';
                }
            }, 4000);
            break;
            
        case 'custom':
            if (customText) {
                loadBtn.innerHTML = customText;
                parentButton.disabled = false;
                parentButton.classList.remove('loading');
            }
            break;
            
        default:
            loadBtn.innerHTML = 'üîÑ Naƒç√≠st data';
            parentButton.disabled = false;
            parentButton.classList.remove('loading');
    }
}

// ========================================
// KALEND√Å≈ò FUNKCE (Z√ÅKLADN√ç)
// ========================================

// Aktualizace zobrazen√≠ aktu√°ln√≠ho mƒõs√≠ce
function updateCurrentMonthDisplay() {
    const currentMonthElement = document.getElementById('currentMonth');
    if (currentMonthElement) {
        const monthNames = [
            'Leden', '√önor', 'B≈ôezen', 'Duben', 'Kvƒõten', 'ƒåerven',
            'ƒåervenec', 'Srpen', 'Z√°≈ô√≠', '≈ò√≠jen', 'Listopad', 'Prosinec'
        ];
        
        const monthName = monthNames[globalState.currentMonth];
        currentMonthElement.textContent = `${monthName} ${globalState.currentYear}`;
    }
}

// Zmƒõna mƒõs√≠ce v kalend√°≈ôi
function changeMonth(direction) {
    globalState.currentMonth += direction;
    
    if (globalState.currentMonth > 11) {
        globalState.currentMonth = 0;
        globalState.currentYear++;
    } else if (globalState.currentMonth < 0) {
        globalState.currentMonth = 11;
        globalState.currentYear--;
    }
    
    updateCurrentMonthDisplay();
    
    // Aktualizace kalend√°≈ôe pokud je aktivn√≠
    if (globalState.currentSection === 'calendar') {
        updateCalendarGrid();
    }
    
    console.log(`üìÖ Calendar changed to: ${globalState.currentMonth + 1}/${globalState.currentYear}`);
}

// P≈ôechod na dne≈°n√≠ mƒõs√≠c
function goToToday() {
    const today = new Date();
    globalState.currentMonth = today.getMonth();
    globalState.currentYear = today.getFullYear();
    
    updateCurrentMonthDisplay();
    
    if (globalState.currentSection === 'calendar') {
        updateCalendarGrid();
    }
    
    showNotification('üìÖ P≈ôe≈°li jste na aktu√°ln√≠ mƒõs√≠c', 'info', 2000);
}

// ========================================
// BUSINESS INFO A RENT FIELDS
// ========================================

// Aktualizace business info karty
function updateBusinessInfo() {
    const businessModel = document.getElementById('businessModel').value;
    const businessInfo = document.getElementById('businessInfo');
    
    if (!businessModel || !businessInfo) {
        if (businessInfo) businessInfo.style.display = 'none';
        return;
    }
    
    businessInfo.style.display = 'block';
    
    let html = '';
    
    switch (businessModel) {
        case 'owner':
            html = `
                <h4>üè™ Re≈æim majitele</h4>
                <ul>
                    <li>Vy jako majitel + 2 brig√°dn√≠ci</li>
                    <li>Mzda: ${CONFIG.HOURLY_WAGE} Kƒç/hodina na osobu</li>
                    <li>Cel√Ω zisk z≈Øst√°v√° v√°m</li>
                    <li><strong>Nejvy≈°≈°√≠ riziko, ale i nejvy≈°≈°√≠ zisk</strong></li>
                </ul>
            `;
            break;
            
        case 'employee':
            html = `
                <h4>üë®‚Äçüíº Re≈æim zamƒõstnance</h4>
                <ul>
                    <li>Vy jako zamƒõstnanec + 1 brig√°dn√≠k</li>
                    <li>Mzda: ${CONFIG.HOURLY_WAGE} Kƒç/hodina</li>
                    <li>Dodateƒçnƒõ 5% z celkov√©ho obratu</li>
                    <li><strong>St≈ôedn√≠ riziko i zisk</strong></li>
                </ul>
            `;
            break;
            
        case 'franchise':
            html = `
                <h4>ü§ù Fran≈°√≠zov√Ω re≈æim</h4>
                <ul>
                    <li>N√°kup donut≈Ø za ${CONFIG.FRANCHISE_PRICE} Kƒç/ks</li>
                    <li>Prodej za v√°mi stanovenou cenu</li>
                    <li>Bez mzdov√Ωch n√°klad≈Ø pro v√°s</li>
                    <li><strong>Nejni≈æ≈°√≠ riziko, ale i nejni≈æ≈°√≠ zisk</strong></li>
                </ul>
            `;
            break;
    }
    
    businessInfo.innerHTML = html;
    
    // Emit event pro aktualizaci predikce
    eventBus.emit('businessModelChanged', { model: businessModel });
}

// Aktualizace pol√≠ n√°jmu podle typu
function updateRentFields() {
    const rentType = document.getElementById('rentType').value;
    
    // Skryt√≠ v≈°ech pol√≠ n√°jmu
    const rentFields = [
        'fixedRentGroup', 'percentageGroup', 
        'mixedFixedGroup', 'mixedPercentageGroup'
    ];
    
    rentFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.style.display = 'none';
        }
    });
    
    // Zobrazen√≠ relevantn√≠ch pol√≠ podle typu
    switch (rentType) {
        case 'fixed':
            const fixedGroup = document.getElementById('fixedRentGroup');
            if (fixedGroup) fixedGroup.style.display = 'block';
            break;
            
        case 'percentage':
            const percentageGroup = document.getElementById('percentageGroup');
            if (percentageGroup) percentageGroup.style.display = 'block';
            break;
            
        case 'mixed':
            const mixedFixed = document.getElementById('mixedFixedGroup');
            const mixedPercentage = document.getElementById('mixedPercentageGroup');
            if (mixedFixed) mixedFixed.style.display = 'block';
            if (mixedPercentage) mixedPercentage.style.display = 'block';
            break;
            
        case 'free':
            // Pro zdarma n√°jem se nezobrazuje nic extra
            break;
    }
    
    console.log(`üí∞ Rent type changed to: ${rentType}`);
    
    // Emit event pro aktualizaci predikce
    eventBus.emit('rentTypeChanged', { type: rentType });
}

// Aktualizace weather karty podle typu akce
function updateWeatherCard() {
    const eventType = document.getElementById('eventType').value;
    const weatherCard = document.getElementById('weatherCard');
    
    if (!weatherCard) return;
    
    if (eventType === 'outdoor') {
        weatherCard.style.display = 'block';
        
        // Zkusit naƒç√≠st poƒças√≠ pokud jsou vyplnƒõny city a date
        const city = document.getElementById('city').value;
        const date = document.getElementById('eventDate').value;
        
        if (city && date) {
            updateWeather();
        }
    } else {
        weatherCard.style.display = 'none';
    }
    
    console.log(`üå§Ô∏è Event type changed to: ${eventType}`);
    
    // Emit event pro aktualizaci predikce
    eventBus.emit('eventTypeChanged', { type: eventType });
}

// ========================================
// PLACEHOLDER FUNKCE PRO DAL≈†√ç ƒå√ÅSTI
// ========================================

// Tyto funkce budou implementov√°ny v dal≈°√≠ch ƒç√°stech app.js

// Placeholder pro loadData - bude v ƒç√°sti 2
function loadData() {
    console.log('üìä loadData() - will be implemented in part 2');
    return Promise.resolve();
}

// Placeholder pro updatePrediction - bude v ƒç√°sti 2  
function updatePrediction() {
    console.log('ü§ñ updatePrediction() - will be implemented in part 2');
}

// Placeholder pro updateWeather - bude v ƒç√°sti 2
function updateWeather() {
    console.log('üå§Ô∏è updateWeather() - will be implemented in part 2');
}

// Placeholder pro updateDistance - bude v ƒç√°sti 3
function updateDistance() {
    console.log('üìç updateDistance() - will be implemented in part 3');
}

// Placeholder pro savePrediction - bude v ƒç√°sti 3
function savePrediction() {
    console.log('üíæ savePrediction() - will be implemented in part 3');
}

// Placeholder pro exportPrediction - bude v ƒç√°sti 3
function exportPrediction() {
    console.log('üìÑ exportPrediction() - will be implemented in part 3');
}

// Placeholder pro modal funkce - budou v ƒç√°sti 3
function closeModal() {
    const modal = document.getElementById('eventModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Placeholder pro inicializaci ostatn√≠ch sekc√≠
function initializeCalendar() {
    console.log('üìÖ initializeCalendar() - will be implemented in part 3');
}

function initializeAnalytics() {
    console.log('üìä initializeAnalytics() - will be implemented in part 3');
}

function updateDataStatistics() {
    console.log('üìä updateDataStatistics() - will be implemented in part 3');
}

function updateCalendarLayout() {
    console.log('üìÖ updateCalendarLayout() - will be implemented in part 3');
}

function updateChartsLayout() {
    console.log('üìä updateChartsLayout() - will be implemented in part 3');
}

function updateCalendarGrid() {
    console.log('üìÖ updateCalendarGrid() - will be implemented in part 3');
}

// ========================================
// FIN√ÅLN√ç LOG
// ========================================

console.log('‚úÖ Donuland Management System - Part 1 loaded successfully');
console.log('üîß Core systems: ‚úÖ Config ‚úÖ State ‚úÖ Events ‚úÖ UI ‚úÖ Navigation');
console.log('‚è≥ Ready for Part 2: Data loading, AI prediction, Weather API');

// Event pro signalizaci dokonƒçen√≠ ƒç√°sti 1
eventBus.emit('part1Loaded', { 
    timestamp: Date.now(),
    version: '1.0.0',
    features: ['core', 'ui', 'navigation', 'events', 'notifications']
});
