/* ========================================
   DONULAND MANAGEMENT SYSTEM - PART 3A (OPRAVENO)
   UI Display & Results Visualization
   ======================================== */

console.log('üç© Donuland Part 3A (Fixed) loading...');

// ========================================
// PREDICTION RESULTS DISPLAY
// ========================================

// Hlavn√≠ funkce pro zobrazen√≠ v√Ωsledk≈Ø predikce
function displayPredictionResults(predictionData) {
    console.log('üéØ Displaying prediction results...');
    
    const { formData, prediction, businessResults } = predictionData;
    const resultsDiv = document.getElementById('predictionResults');
    
    if (!resultsDiv) {
        console.error('‚ùå Results div not found');
        return;
    }
    
    try {
        // Generov√°n√≠ doporuƒçen√≠
        const recommendations = generateRecommendations(formData, prediction, businessResults);
        
        // Hlavn√≠ v√Ωsledky
        const mainResultsHtml = generateMainResults(prediction, businessResults);
        
        // Faktory breakdown
        const factorsHtml = generateFactorsBreakdown(prediction.factors);
        
        // Business breakdown
        const businessHtml = generateBusinessBreakdown(businessResults);
        
        // Doporuƒçen√≠
        const recommendationsHtml = generateRecommendationsHtml(recommendations);
        
        // Sestaven√≠ cel√©ho HTML
        const html = `
            <div class="prediction-results-container">
                ${mainResultsHtml}
                ${factorsHtml}
                ${businessHtml}
                ${recommendationsHtml}
            </div>
        `;
        
        resultsDiv.innerHTML = html;
        
        // Animace zobrazen√≠
        resultsDiv.classList.add('fade-in');
        
        // Zobrazen√≠ action buttons
        showActionButtons();
        
        console.log('‚úÖ Prediction results displayed successfully');
        
    } catch (error) {
        console.error('‚ùå Error displaying prediction results:', error);
        displayErrorResults(error.message);
    }
}

// Generov√°n√≠ hlavn√≠ch v√Ωsledk≈Ø
function generateMainResults(prediction, businessResults) {
    const sales = prediction.predictedSales;
    const confidence = prediction.confidence;
    const revenue = businessResults.revenue;
    const profit = businessResults.profit;
    const roi = businessResults.roi;
    const margin = businessResults.margin;
    
    // Urƒçen√≠ barvy podle ziskovosti
    let profitColor = '#28a745'; // Zelen√°
    let profitIcon = '‚úÖ';
    
    if (profit <= 0) {
        profitColor = '#dc3545'; // ƒåerven√°
        profitIcon = '‚ùå';
    } else if (profit < 1000) {
        profitColor = '#ffc107'; // ≈Ωlut√°
        profitIcon = '‚ö†Ô∏è';
    }
    
    // Urƒçen√≠ barvy podle confidence
    let confidenceColor = '#28a745';
    if (confidence < 60) confidenceColor = '#ffc107';
    if (confidence < 40) confidenceColor = '#dc3545';
    
    return `
        <div class="main-results">
            <h3>üéØ V√Ωsledky AI predikce</h3>
            
            <div class="results-grid">
                <div class="result-item primary">
                    <div class="result-icon">üç©</div>
                    <div class="result-value">${formatNumber(sales)}</div>
                    <div class="result-label">Predikovan√Ω prodej (ks)</div>
                </div>
                
                <div class="result-item">
                    <div class="result-icon">üéØ</div>
                    <div class="result-value" style="color: ${confidenceColor};">${confidence}%</div>
                    <div class="result-label">Confidence predikce</div>
                </div>
                
                <div class="result-item">
                    <div class="result-icon">üí∞</div>
                    <div class="result-value">${formatCurrency(revenue)}</div>
                    <div class="result-label">Oƒçek√°van√Ω obrat</div>
                </div>
                
                <div class="result-item">
                    <div class="result-icon">${profitIcon}</div>
                    <div class="result-value" style="color: ${profitColor};">${formatCurrency(profit)}</div>
                    <div class="result-label">Oƒçek√°van√Ω zisk</div>
                </div>
                
                <div class="result-item">
                    <div class="result-icon">üìà</div>
                    <div class="result-value" style="color: ${roi > 20 ? '#28a745' : roi > 0 ? '#ffc107' : '#dc3545'};">${roi.toFixed(1)}%</div>
                    <div class="result-label">ROI</div>
                </div>
                
                <div class="result-item">
                    <div class="result-icon">üìä</div>
                    <div class="result-value" style="color: ${margin > 30 ? '#28a745' : margin > 15 ? '#ffc107' : '#dc3545'};">${margin.toFixed(1)}%</div>
                    <div class="result-label">Mar≈æe</div>
                </div>
            </div>
        </div>
    `;
}

// Generov√°n√≠ breakdown faktor≈Ø
function generateFactorsBreakdown(factors) {
    return `
        <div class="factors-breakdown">
            <h4>üß† Rozklad AI faktor≈Ø</h4>
            <div class="factors-explanation">
                <p>Fin√°ln√≠ konverze: <strong>${(factors.final * 100).toFixed(2)}%</strong> n√°v≈°tƒõvn√≠k≈Ø koup√≠ donut</p>
            </div>
            
            <div class="factors-grid">
                <div class="factor-item">
                    <div class="factor-name">üìã Kategorie</div>
                    <div class="factor-value">${(factors.base * 100).toFixed(1)}%</div>
                    <div class="factor-bar">
                        <div class="factor-fill" style="width: ${factors.base * 100}%"></div>
                    </div>
                </div>
                
                <div class="factor-item">
                    <div class="factor-name">üìä Historick√© data</div>
                    <div class="factor-value">${(factors.historical * 100).toFixed(0)}%</div>
                    <div class="factor-bar">
                        <div class="factor-fill" style="width: ${Math.min(factors.historical * 50, 100)}%; background-color: ${factors.historical > 1 ? '#28a745' : factors.historical < 1 ? '#dc3545' : '#6c757d'}"></div>
                    </div>
                </div>
                
                <div class="factor-item">
                    <div class="factor-name">üèôÔ∏è Mƒõsto</div>
                    <div class="factor-value">${(factors.city * 100).toFixed(0)}%</div>
                    <div class="factor-bar">
                        <div class="factor-fill" style="width: ${Math.min(factors.city * 50, 100)}%; background-color: ${factors.city > 1 ? '#28a745' : factors.city < 1 ? '#dc3545' : '#6c757d'}"></div>
                    </div>
                </div>
                
                <div class="factor-item">
                    <div class="factor-name">üè™ Konkurence</div>
                    <div class="factor-value">${(factors.competition * 100).toFixed(0)}%</div>
                    <div class="factor-bar">
                        <div class="factor-fill" style="width: ${Math.min(factors.competition * 50, 100)}%; background-color: ${factors.competition > 1 ? '#28a745' : factors.competition < 1 ? '#dc3545' : '#6c757d'}"></div>
                    </div>
                </div>
                
                <div class="factor-item">
                    <div class="factor-name">üìÖ Sez√≥na</div>
                    <div class="factor-value">${(factors.seasonal * 100).toFixed(0)}%</div>
                    <div class="factor-bar">
                        <div class="factor-fill" style="width: ${Math.min(factors.seasonal * 50, 100)}%; background-color: ${factors.seasonal > 1 ? '#28a745' : factors.seasonal < 1 ? '#dc3545' : '#6c757d'}"></div>
                    </div>
                </div>
                
                <div class="factor-item">
                    <div class="factor-name">üë• Velikost akce</div>
                    <div class="factor-value">${(factors.size * 100).toFixed(0)}%</div>
                    <div class="factor-bar">
                        <div class="factor-fill" style="width: ${Math.min(factors.size * 50, 100)}%; background-color: ${factors.size > 1 ? '#28a745' : factors.size < 1 ? '#dc3545' : '#6c757d'}"></div>
                    </div>
                </div>
                
                <div class="factor-item">
                    <div class="factor-name">üå§Ô∏è Poƒças√≠</div>
                    <div class="factor-value">${(factors.weather * 100).toFixed(0)}%</div>
                    <div class="factor-bar">
                        <div class="factor-fill" style="width: ${Math.min(factors.weather * 50, 100)}%; background-color: ${factors.weather > 1 ? '#28a745' : factors.weather < 1 ? '#dc3545' : '#6c757d'}"></div>
                    </div>
                </div>
                
                <div class="factor-item">
                    <div class="factor-name">‚è∞ D√©lka akce</div>
                    <div class="factor-value">${(factors.duration * 100).toFixed(0)}%</div>
                    <div class="factor-bar">
                        <div class="factor-fill" style="width: ${Math.min(factors.duration * 50, 100)}%; background-color: ${factors.duration > 1 ? '#28a745' : factors.duration < 1 ? '#dc3545' : '#6c757d'}"></div>
                    </div>
                </div>
            </div>
            
            <div class="factors-note">
                <small>üí° Faktory >100% zvy≈°uj√≠ prodej, <100% sni≈æuj√≠. Zelen√° = pozitivn√≠, ƒçerven√° = negativn√≠ vliv.</small>
            </div>
        </div>
    `;
}

// Generov√°n√≠ business breakdown
function generateBusinessBreakdown(businessResults) {
    const { revenue, costs, totalCosts, profit, breakeven, metadata } = businessResults;
    
    return `
        <div class="business-breakdown">
            <h4>üíº Finanƒçn√≠ anal√Ωza</h4>
            
            <div class="business-summary">
                <div class="business-metric">
                    <span class="metric-label">Break-even point:</span>
                    <span class="metric-value">${formatNumber(breakeven)} ks</span>
                </div>
                <div class="business-metric">
                    <span class="metric-label">Business model:</span>
                    <span class="metric-value">${getBusinessModelLabel(metadata.businessModel)}</span>
                </div>
                <div class="business-metric">
                    <span class="metric-label">Cena za kus:</span>
                    <span class="metric-value">${formatCurrency(metadata.pricePerUnit)}</span>
                </div>
            </div>
            
            <div class="costs-breakdown">
                <h5>üìä Rozpis n√°klad≈Ø</h5>
                <div class="costs-grid">
                    <div class="cost-item">
                        <div class="cost-icon">üç©</div>
                        <div class="cost-details">
                            <div class="cost-name">V√Ωroba</div>
                            <div class="cost-value">${formatCurrency(costs.production)}</div>
                        </div>
                    </div>
                    
                    <div class="cost-item">
                        <div class="cost-icon">üë®‚Äçüíº</div>
                        <div class="cost-details">
                            <div class="cost-name">Mzdy</div>
                            <div class="cost-value">${formatCurrency(costs.labor)}</div>
                        </div>
                    </div>
                    
                    <div class="cost-item">
                        <div class="cost-icon">üöó</div>
                        <div class="cost-details">
                            <div class="cost-name">Doprava</div>
                            <div class="cost-value">${formatCurrency(costs.transport)}</div>
                        </div>
                    </div>
                    
                    <div class="cost-item">
                        <div class="cost-icon">üè¢</div>
                        <div class="cost-details">
                            <div class="cost-name">N√°jem</div>
                            <div class="cost-value">${formatCurrency(costs.rent)}</div>
                        </div>
                    </div>
                    
                    ${costs.revenueShare > 0 ? `
                    <div class="cost-item">
                        <div class="cost-icon">üìä</div>
                        <div class="cost-details">
                            <div class="cost-name">% z obratu</div>
                            <div class="cost-value">${formatCurrency(costs.revenueShare)}</div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="costs-total">
                    <div class="total-row revenue">
                        <span>üí∞ Celkov√Ω obrat:</span>
                        <span>${formatCurrency(revenue)}</span>
                    </div>
                    <div class="total-row costs">
                        <span>üí∏ Celkov√© n√°klady:</span>
                        <span>${formatCurrency(totalCosts)}</span>
                    </div>
                    <div class="total-row profit ${profit > 0 ? 'positive' : 'negative'}">
                        <span><strong>${profit > 0 ? '‚úÖ' : '‚ùå'} ƒåist√Ω zisk:</strong></span>
                        <span><strong>${formatCurrency(profit)}</strong></span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Generov√°n√≠ doporuƒçen√≠ HTML
function generateRecommendationsHtml(recommendations) {
    if (!recommendations || recommendations.length === 0) {
        return `
            <div class="recommendations">
                <h4>üí° Doporuƒçen√≠</h4>
                <div class="recommendation-item success">
                    <div class="recommendation-icon">‚úÖ</div>
                    <div class="recommendation-content">
                        <div class="recommendation-title">V√Ωborn√© podm√≠nky</div>
                        <div class="recommendation-text">V≈°echny faktory jsou optim√°ln√≠ pro √∫spƒõ≈°nou akci!</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    const recommendationsHtml = recommendations.map(rec => `
        <div class="recommendation-item ${rec.type}">
            <div class="recommendation-icon">${rec.icon}</div>
            <div class="recommendation-content">
                <div class="recommendation-title">${rec.title}</div>
                <div class="recommendation-text">${rec.text}</div>
            </div>
        </div>
    `).join('');
    
    return `
        <div class="recommendations">
            <h4>üí° Doporuƒçen√≠ pro √∫spƒõ≈°nou akci</h4>
            ${recommendationsHtml}
        </div>
    `;
}

// ========================================
// ERROR HANDLING
// ========================================

// Zobrazen√≠ chyby p≈ôi predikci
function displayErrorResults(errorMessage) {
    const resultsDiv = document.getElementById('predictionResults');
    if (!resultsDiv) return;
    
    resultsDiv.innerHTML = `
        <div class="prediction-error">
            <div class="error-icon">‚ùå</div>
            <h4>Chyba p≈ôi v√Ωpoƒçtu predikce</h4>
            <p>${escapeHtml(errorMessage)}</p>
            <button class="btn btn-retry" onclick="retryPrediction()">üîÑ Zkusit znovu</button>
        </div>
    `;
}

// Retry predikce
function retryPrediction() {
    console.log('üîÑ Retrying prediction...');
    
    const validation = validateRequiredFields();
    if (validation.valid) {
        updatePrediction();
    } else {
        showNotification('‚ùå Opravte chyby ve formul√°≈ôi p≈ôed opakov√°n√≠m', 'error');
    }
}

// ========================================
// ACTION BUTTONS
// ========================================

// Zobrazen√≠ action buttons
function showActionButtons() {
    const actionButtons = document.getElementById('actionButtons');
    if (actionButtons) {
        actionButtons.style.display = 'flex';
        actionButtons.classList.add('fade-in');
    }
}

// Skryt√≠ action buttons
function hideActionButtons() {
    const actionButtons = document.getElementById('actionButtons');
    if (actionButtons) {
        actionButtons.style.display = 'none';
    }
}

// ========================================
// UTILITY FUNCTIONS
// ========================================

// Z√≠sk√°n√≠ labelu pro business model
function getBusinessModelLabel(businessModel) {
    const labels = {
        'owner': 'üè™ Majitel',
        'employee': 'üë®‚Äçüíº Zamƒõstnanec',
        'franchise': 'ü§ù Fran≈°√≠za'
    };
    
    return labels[businessModel] || businessModel;
}

// ========================================
// PLACEHOLDER DISPLAY
// ========================================

// Zobrazen√≠ placeholder p≈ôi naƒçten√≠
function displayPredictionPlaceholder() {
    const resultsDiv = document.getElementById('predictionResults');
    if (!resultsDiv) return;
    
    resultsDiv.innerHTML = `
        <div class="prediction-placeholder">
            <div class="placeholder-icon">ü§ñ</div>
            <h4>P≈ôipraveno k anal√Ωze</h4>
            <p>Vypl≈àte v≈°echna povinn√° pole oznaƒçen√° * pro spu≈°tƒõn√≠ AI predikce prodeje</p>
            <div class="required-fields-list">
                <div class="field-status" id="status-eventName">üìù N√°zev akce</div>
                <div class="field-status" id="status-category">üìã Kategorie</div>
                <div class="field-status" id="status-city">üèôÔ∏è Mƒõsto</div>
                <div class="field-status" id="status-dates">üìÖ Datum akce</div>
                <div class="field-status" id="status-visitors">üë• N√°v≈°tƒõvnost</div>
                <div class="field-status" id="status-competition">üè™ Konkurence</div>
                <div class="field-status" id="status-eventType">üè¢ Typ akce</div>
                <div class="field-status" id="status-businessModel">üíº Business model</div>
                <div class="field-status" id="status-rentType">üí∞ Typ n√°jmu</div>
            </div>
        </div>
    `;
}

// Aktualizace statusu pol√≠ v placeholder
function updateFieldsStatus() {
    const formData = gatherFormData();
    
    const fields = [
        { id: 'status-eventName', condition: formData.eventName && formData.eventName.trim() },
        { id: 'status-category', condition: formData.category },
        { id: 'status-city', condition: formData.city && formData.city.trim() },
        { id: 'status-dates', condition: formData.eventDateFrom && formData.eventDateTo },
        { id: 'status-visitors', condition: formData.visitors > 0 },
        { id: 'status-competition', condition: formData.competition },
        { id: 'status-eventType', condition: formData.eventType },
        { id: 'status-businessModel', condition: formData.businessModel },
        { id: 'status-rentType', condition: formData.rentType }
    ];
    
    fields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            if (field.condition) {
                element.classList.add('completed');
                element.style.color = '#28a745';
                if (!element.textContent.includes('‚úÖ')) {
                    element.textContent = '‚úÖ ' + element.textContent.replace(/^[üìùüìãüèôÔ∏èüìÖüë•üè™üè¢üíºüí∞]\s/, '');
                }
            } else {
                element.classList.remove('completed');
                element.style.color = '#6c757d';
                element.textContent = element.textContent.replace('‚úÖ ', '');
            }
        }
    });
}

// ========================================
// LOADING STATES
// ========================================

// Zobrazen√≠ loading stavu
function displayPredictionLoading() {
    const resultsDiv = document.getElementById('predictionResults');
    if (!resultsDiv) return;
    
    resultsDiv.innerHTML = `
        <div class="prediction-loading">
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
            <h4>ü§ñ AI poƒç√≠t√° predikci...</h4>
            <p>Analyzuji historick√° data, poƒças√≠ a v≈°echny faktory</p>
            <div class="loading-steps">
                <div class="loading-step active">üìä Naƒç√≠t√°m historick√° data</div>
                <div class="loading-step">üå§Ô∏è Analyzuji poƒças√≠</div>
                <div class="loading-step">üß† Poƒç√≠t√°m AI faktory</div>
                <div class="loading-step">üíº Kalkuluji business metriky</div>
                <div class="loading-step">üéØ Finalizuji predikci</div>
            </div>
        </div>
    `;
    
    // Animace krok≈Ø
    animateLoadingSteps();
}

// Animace loading krok≈Ø
function animateLoadingSteps() {
    const steps = document.querySelectorAll('.loading-step');
    let currentStep = 0;
    
    const interval = setInterval(() => {
        if (currentStep < steps.length) {
            steps[currentStep].classList.add('active');
            if (currentStep > 0) {
                steps[currentStep - 1].classList.remove('active');
                steps[currentStep - 1].classList.add('completed');
            }
            currentStep++;
        } else {
            clearInterval(interval);
        }
    }, 500);
}

// ========================================
// EVENT LISTENERS PRO PART 3A (OPRAVENO)
// ========================================

// Event listener pro vypoƒç√≠tanou predikci
eventBus.on('predictionCalculated', (predictionData) => {
    console.log('üéØ Prediction calculated, displaying results');
    displayPredictionResults(predictionData);
});

// Event listener pro zaƒç√°tek prediction loading
eventBus.on('predictionStarted', () => {
    console.log('ü§ñ Prediction started, showing loading');
    displayPredictionLoading();
    hideActionButtons();
});

// Event listener pro chybu predikce
eventBus.on('predictionError', (error) => {
    console.log('‚ùå Prediction error, showing error message');
    displayErrorResults(error.message || 'Nezn√°m√° chyba p≈ôi v√Ωpoƒçtu predikce');
    hideActionButtons();
});

// ========================================
// INICIALIZACE PART 3A
// ========================================

// Inicializace p≈ôi naƒçten√≠ str√°nky
document.addEventListener('DOMContentLoaded', function() {
    console.log('üé® Initializing Part 3A UI...');
    
    // Zobrazen√≠ placeholder na zaƒç√°tku
    setTimeout(() => {
        displayPredictionPlaceholder();
    }, 100);
    
    // Skryt√≠ action buttons na zaƒç√°tku
    hideActionButtons();
    
    console.log('‚úÖ Part 3A UI initialized');
});

// ========================================
// FINALIZACE PART 3A
// ========================================

console.log('‚úÖ Donuland Part 3A (Fixed) loaded successfully');
console.log('üé® Features: ‚úÖ Results Display ‚úÖ Factors Breakdown ‚úÖ Business Analysis ‚úÖ Recommendations');
console.log('üéØ UI States: Placeholder ‚Üí Loading ‚Üí Results/Error');
console.log('üí° Interactive: Field status tracking + Action buttons');
console.log('‚è≥ Ready for Part 3B: Enhanced Validation & Form Features');

// Event pro signalizaci dokonƒçen√≠ ƒç√°sti 3A
eventBus.emit('part3aLoaded', { 
    timestamp: Date.now(),
    version: '1.1.0',
    features: ['results-display', 'factors-breakdown', 'business-analysis', 'recommendations-display', 'loading-states', 'error-handling']
});
/* ========================================
   DONULAND MANAGEMENT SYSTEM - PART 3B (OPRAVENO)
   Enhanced Validation & Smart Form Features
   ======================================== */

console.log('üç© Donuland Part 3B (Fixed) loading...');

// ========================================
// ENHANCED FORM VALIDATION (OPRAVENO)
// ========================================

// Vylep≈°en√° validace formul√°≈ôe s opravou konfliktu
function validateRequiredFieldsEnhanced() {
    console.log('üîç Enhanced validation running...');
    
    const requiredFields = [
        { id: 'eventName', name: 'N√°zev akce', minLength: 3 },
        { id: 'category', name: 'Kategorie' },
        { id: 'city', name: 'Mƒõsto/Lokalita', minLength: 2 },
        { id: 'eventDateFrom', name: 'Datum od' },
        { id: 'eventDateTo', name: 'Datum do' },
        { id: 'visitors', name: 'N√°v≈°tƒõvnost', min: 50, max: 100000 },
        { id: 'competition', name: 'Konkurence' },
        { id: 'eventType', name: 'Typ akce' },
        { id: 'businessModel', name: 'Business model' },
        { id: 'rentType', name: 'Typ n√°jmu' }
    ];
    
    let allValid = true;
    const errors = [];
    
    requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        const isValid = validateSingleFieldEnhanced(element, field);
        
        if (!isValid.valid) {
            allValid = false;
            errors.push(...isValid.errors);
            markFieldAsError(element, isValid.errors);
        } else {
            markFieldAsValid(element);
        }
    });
    
    // Speci√°ln√≠ validace
    const specialValidation = performSpecialValidationEnhanced();
    if (!specialValidation.valid) {
        allValid = false;
        errors.push(...specialValidation.errors);
    }
    
    return { valid: allValid, errors: errors };
}

// Validace jednotliv√©ho pole s enhanced funkcemi
function validateSingleFieldEnhanced(element, fieldConfig) {
    if (!element) {
        return { valid: false, errors: [`Pole ${fieldConfig.name} nebylo nalezeno`] };
    }
    
    const value = element.value.trim();
    const errors = [];
    
    // Z√°kladn√≠ povinnost
    if (!value) {
        errors.push(`${fieldConfig.name} je povinn√© pole`);
        return { valid: false, errors };
    }
    
    // Minim√°ln√≠ d√©lka pro textov√° pole
    if (fieldConfig.minLength && value.length < fieldConfig.minLength) {
        errors.push(`${fieldConfig.name} mus√≠ m√≠t alespo≈à ${fieldConfig.minLength} znak≈Ø`);
    }
    
    // ƒå√≠seln√© rozsahy
    if (fieldConfig.min !== undefined || fieldConfig.max !== undefined) {
        const numValue = parseFloat(value);
        
        if (isNaN(numValue)) {
            errors.push(`${fieldConfig.name} mus√≠ b√Ωt ƒç√≠slo`);
        } else {
            if (fieldConfig.min !== undefined && numValue < fieldConfig.min) {
                errors.push(`${fieldConfig.name} mus√≠ b√Ωt alespo≈à ${fieldConfig.min}`);
            }
            if (fieldConfig.max !== undefined && numValue > fieldConfig.max) {
                errors.push(`${fieldConfig.name} nesm√≠ b√Ωt v√≠ce ne≈æ ${fieldConfig.max}`);
            }
        }
    }
    
    return { valid: errors.length === 0, errors };
}

// Speci√°ln√≠ validace s enhanced funkcemi
function performSpecialValidationEnhanced() {
    const errors = [];
    
    // Validace datum≈Ø
    const dateFrom = document.getElementById('eventDateFrom').value;
    const dateTo = document.getElementById('eventDateTo').value;
    
    if (dateFrom && dateTo) {
        const dateFromObj = new Date(dateFrom);
        const dateToObj = new Date(dateTo);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Datum do mus√≠ b√Ωt >= datum od
        if (dateToObj < dateFromObj) {
            errors.push('Datum do nesm√≠ b√Ωt d≈ô√≠ve ne≈æ datum od');
            markFieldAsError(document.getElementById('eventDateTo'), ['Neplatn√© datum']);
        }
        
        // Varov√°n√≠ pro p≈ô√≠li≈° vzd√°len√© budouc√≠ akce
        const maxFutureDate = new Date();
        maxFutureDate.setFullYear(maxFutureDate.getFullYear() + 1);
        
        if (dateFromObj > maxFutureDate) {
            errors.push('Akce je p≈ô√≠li≈° daleko v budoucnosti (max 1 rok)');
        }
        
        // Info pro akce v minulosti (nen√≠ chyba)
        if (dateFromObj < today) {
            setTimeout(() => {
                showNotification('‚ö†Ô∏è Akce je napl√°nov√°na v minulosti', 'warning', 3000);
            }, 100);
        }
    }
    
    // Validace business logiky
    const rentType = document.getElementById('rentType').value;
    
    // Specifick√© validace podle rent type
    if (rentType === 'fixed') {
        const fixedRent = parseFloat(document.getElementById('fixedRent')?.value || 0);
        if (fixedRent <= 0) {
            errors.push('Fixn√≠ n√°jem mus√≠ b√Ωt vy≈°≈°√≠ ne≈æ 0 Kƒç');
            const fixedRentEl = document.getElementById('fixedRent');
            if (fixedRentEl) markFieldAsError(fixedRentEl, ['Neplatn√° hodnota']);
        }
    }
    
    if (rentType === 'percentage') {
        const percentage = parseFloat(document.getElementById('percentage')?.value || 0);
        if (percentage <= 0 || percentage > 50) {
            errors.push('Procenta z obratu mus√≠ b√Ωt mezi 1-50%');
            const percentageEl = document.getElementById('percentage');
            if (percentageEl) markFieldAsError(percentageEl, ['Neplatn√° hodnota']);
        }
    }
    
    if (rentType === 'mixed') {
        const mixedFixed = parseFloat(document.getElementById('mixedFixed')?.value || 0);
        const mixedPercentage = parseFloat(document.getElementById('mixedPercentage')?.value || 0);
        
        if (mixedFixed <= 0 && mixedPercentage <= 0) {
            errors.push('Kombinovan√Ω n√°jem mus√≠ m√≠t alespo≈à jednu hodnotu > 0');
        }
    }
    
    // Validace ceny
    const price = parseFloat(document.getElementById('price')?.value || 0);
    if (price < 30 || price > 100) {
        // Nen√≠ chyba, jen upozornƒõn√≠
        setTimeout(() => {
            showNotification('üí° Neobvykl√° cena - doporuƒçeno 45-55 Kƒç', 'info', 3000);
        }, 100);
    }
    
    return { valid: errors.length === 0, errors };
}

// Oznaƒçen√≠ pole jako chybn√©
function markFieldAsError(element, errors) {
    if (!element) return;
    
    element.classList.add('error');
    element.classList.remove('valid');
    element.setAttribute('title', errors.join(', '));
    
    // P≈ôid√°n√≠ chybov√© zpr√°vy
    let errorDiv = element.parentElement.querySelector('.field-error');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        element.parentElement.appendChild(errorDiv);
    }
    
    errorDiv.innerHTML = `
        <span class="error-icon">‚ö†Ô∏è</span>
        <span class="error-text">${errors[0]}</span>
    `;
    errorDiv.style.display = 'block';
}

// Oznaƒçen√≠ pole jako validn√≠
function markFieldAsValid(element) {
    if (!element) return;
    
    element.classList.remove('error');
    element.classList.add('valid');
    element.removeAttribute('title');
    
    // Odstranƒõn√≠ chybov√© zpr√°vy
    const errorDiv = element.parentElement.querySelector('.field-error');
    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
    
    // P≈ôid√°n√≠ success efektu (doƒçasnƒõ)
    element.style.borderColor = '#28a745';
    element.style.boxShadow = '0 0 0 2px rgba(40, 167, 69, 0.2)';
    
    // Odstranƒõn√≠ po 2 sekund√°ch
    setTimeout(() => {
        if (element.classList.contains('valid')) {
            element.style.borderColor = '';
            element.style.boxShadow = '';
        }
    }, 2000);
}

// ========================================
// REAL-TIME FORM VALIDATION
// ========================================

// Nastaven√≠ real-time validace
function setupRealTimeValidation() {
    console.log('‚ö° Setting up real-time validation...');
    
    const formElements = document.querySelectorAll('input, select, textarea');
    
    formElements.forEach(element => {
        // Debounced validation p≈ôi psan√≠
        const debouncedValidation = debounce(() => {
            validateAndTriggerUpdate(element);
        }, 300);
        
        // Event listeners
        element.addEventListener('input', debouncedValidation);
        element.addEventListener('change', () => {
            validateAndTriggerUpdate(element);
        });
        
        element.addEventListener('blur', () => {
            validateSingleFieldByElement(element);
        });
        
        element.addEventListener('focus', () => {
            // Odstranƒõn√≠ error styling p≈ôi focusu
            element.classList.remove('error');
            const errorDiv = element.parentElement.querySelector('.field-error');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        });
    });
    
    console.log('‚úÖ Real-time validation setup complete');
}

// Validace a trigger update
function validateAndTriggerUpdate(element) {
    validateSingleFieldByElement(element);
    updatePredictionTriggerEnhanced();
}

// Validace jednoho pole podle elementu
function validateSingleFieldByElement(element) {
    if (!element || !element.id) return;
    
    // Naj√≠t konfiguraci pole
    const fieldConfigs = {
        'eventName': { name: 'N√°zev akce', minLength: 3 },
        'category': { name: 'Kategorie' },
        'city': { name: 'Mƒõsto/Lokalita', minLength: 2 },
        'eventDateFrom': { name: 'Datum od' },
        'eventDateTo': { name: 'Datum do' },
        'visitors': { name: 'N√°v≈°tƒõvnost', min: 50, max: 100000 },
        'competition': { name: 'Konkurence' },
        'eventType': { name: 'Typ akce' },
        'businessModel': { name: 'Business model' },
        'rentType': { name: 'Typ n√°jmu' },
        'price': { name: 'Cena', min: 30, max: 100 }
    };
    
    const fieldConfig = fieldConfigs[element.id];
    if (!fieldConfig) return;
    
    const result = validateSingleFieldEnhanced(element, fieldConfig);
    
    if (result.valid) {
        markFieldAsValid(element);
    } else {
        markFieldAsError(element, result.errors);
    }
}

// ========================================
// SMART FORM SUGGESTIONS
// ========================================

// Inteligentn√≠ n√°vrhy p≈ôi psan√≠
function setupSmartSuggestions() {
    console.log('üß† Setting up smart suggestions...');
    
    // N√°vrhy pro mƒõsta na z√°kladƒõ historick√Ωch dat
    setupCitySuggestionsEnhanced();
    
    // Auto-kategorization na z√°kladƒõ n√°zvu
    setupAutoCategorizationEnhanced();
    
    // Smart defaults
    setupSmartDefaultsEnhanced();
}

// Enhanced n√°vrhy mƒõst z historick√Ωch dat
function setupCitySuggestionsEnhanced() {
    const cityInput = document.getElementById('city');
    if (!cityInput) return;
    
    cityInput.addEventListener('input', debounce(() => {
        const value = cityInput.value.toLowerCase().trim();
        if (value.length < 2) return;
        
        // Naj√≠t podobn√° mƒõsta v historick√Ωch datech
        if (globalState.historicalData && globalState.historicalData.length > 0) {
            const suggestions = globalState.historicalData
                .map(record => record.city)
                .filter(city => city && city.toLowerCase().includes(value))
                .filter((city, index, self) => self.indexOf(city) === index) // unique
                .slice(0, 5);
            
            if (suggestions.length > 0) {
                showCitySuggestionsEnhanced(cityInput, suggestions);
            }
        }
    }, 300));
}

// Zobrazen√≠ n√°vrh≈Ø mƒõst
function showCitySuggestionsEnhanced(input, suggestions) {
    // Odstranƒõn√≠ star√Ωch n√°vrh≈Ø
    const existingSuggestions = document.querySelector('.city-suggestions');
    if (existingSuggestions) {
        existingSuggestions.remove();
    }
    
    // Vytvo≈ôen√≠ nov√Ωch n√°vrh≈Ø
    const suggestionsDiv = document.createElement('div');
    suggestionsDiv.className = 'city-suggestions';
    suggestionsDiv.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
    `;
    
    suggestionsDiv.innerHTML = suggestions.map(city => 
        `<div class="suggestion-item" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" 
              onclick="selectCitySuggestionEnhanced('${escapeHtml(city)}')"
              onmouseover="this.style.backgroundColor='#f5f5f5'"
              onmouseout="this.style.backgroundColor=''">${escapeHtml(city)}</div>`
    ).join('');
    
    input.parentElement.style.position = 'relative';
    input.parentElement.appendChild(suggestionsDiv);
    
    // Auto-hide po 10 sekund√°ch
    setTimeout(() => {
        if (suggestionsDiv.parentElement) {
            suggestionsDiv.remove();
        }
    }, 10000);
}

// V√Ωbƒõr n√°vrhu mƒõsta
function selectCitySuggestionEnhanced(city) {
    const cityInput = document.getElementById('city');
    if (cityInput) {
        cityInput.value = city;
        cityInput.dispatchEvent(new Event('change'));
        
        // Odstranƒõn√≠ n√°vrh≈Ø
        const suggestions = document.querySelector('.city-suggestions');
        if (suggestions) {
            suggestions.remove();
        }
        
        // Trigger distance calculation
        eventBus.emit('cityChanged', { city: city });
    }
}

// Auto-kategorizace na z√°kladƒõ n√°zvu akce
function setupAutoCategorizationEnhanced() {
    const eventNameInput = document.getElementById('eventName');
    const categorySelect = document.getElementById('category');
    
    if (!eventNameInput || !categorySelect) return;
    
    eventNameInput.addEventListener('input', debounce(() => {
        const name = eventNameInput.value.toLowerCase();
        
        // U≈æ je kategorie vybran√°? Nep≈ôepisuj
        if (categorySelect.value) return;
        
        // Kl√≠ƒçov√° slova pro kategorie
        const categoryKeywords = {
            'food festival': ['food', 'fest', 'gastro', 'j√≠dlo', 'kulin√°≈ô', 'chu≈•', 'gurm√°n', 'burger', 'pizza'],
            'veletrh': ['veletrh', 'v√Ωstava', 'trh', 'ƒçoko', 'chocolate', 'jarmark', 'cokofest'],
            'koncert': ['koncert', 'hudba', 'festival', 'music', 'kapela', 'zpƒõv', 'band'],
            'kulturn√≠ akce': ['kultura', 'divadlo', 'muzeum', 'galerie', 'umƒõn√≠', 'v√Ωstava', 'film'],
            'sportovn√≠': ['sport', 'bƒõh', 'maraton', 'z√°vod', 'turnaj', 'poh√°r', 'cyklo', 'fotbal']
        };
        
        for (const [category, keywords] of Object.entries(categoryKeywords)) {
            if (keywords.some(keyword => name.includes(keyword))) {
                categorySelect.value = category;
                categorySelect.dispatchEvent(new Event('change'));
                
                // Notifikace o auto-v√Ωbƒõru
                showNotification(`ü§ñ Auto-vybr√°no: ${category}`, 'info', 2000);
                break;
            }
        }
    }, 1000));
}

// Smart defaults na z√°kladƒõ kontextu
function setupSmartDefaultsEnhanced() {
    // Auto-nastaven√≠ datumu do = datum od pro jednodenn√≠ akce
    const dateFromInput = document.getElementById('eventDateFrom');
    const dateToInput = document.getElementById('eventDateTo');
    
    if (dateFromInput && dateToInput) {
        dateFromInput.addEventListener('change', () => {
            if (!dateToInput.value && dateFromInput.value) {
                dateToInput.value = dateFromInput.value;
                dateToInput.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // Smart business model doporuƒçen√≠
    const visitorsInput = document.getElementById('visitors');
    const businessModelSelect = document.getElementById('businessModel');
    
    if (visitorsInput && businessModelSelect) {
        visitorsInput.addEventListener('change', debounce(() => {
            const visitors = parseInt(visitorsInput.value);
            
            if (!businessModelSelect.value && visitors > 0) {
                let recommendedModel = 'owner'; // default
                
                if (visitors < 1000) {
                    recommendedModel = 'franchise'; // Men≈°√≠ riziko pro mal√© akce
                } else if (visitors > 10000) {
                    recommendedModel = 'owner'; // Vy≈°≈°√≠ zisk pro velk√© akce
                } else {
                    recommendedModel = 'employee'; // St≈ôedn√≠ cesta
                }
                
                businessModelSelect.value = recommendedModel;
                businessModelSelect.dispatchEvent(new Event('change'));
                
                const modelNames = {
                    'owner': 'Majitel',
                    'employee': 'Zamƒõstnanec', 
                    'franchise': 'Fran≈°√≠za'
                };
                
                showNotification(`üí° Doporuƒçeno: ${modelNames[recommendedModel]} pro ${formatNumber(visitors)} n√°v≈°tƒõvn√≠k≈Ø`, 'info', 3000);
            }
        }, 1500));
    }
}

// ========================================
// FORM PROGRESS TRACKING
// ========================================

// Aktualizace pokroku formul√°≈ôe
function updateFormProgressEnhanced() {
    const requiredFields = [
        'eventName', 'category', 'city', 'eventDateFrom', 'eventDateTo', 
        'visitors', 'competition', 'eventType', 'businessModel', 'rentType'
    ];
    
    let completedFields = 0;
    
    requiredFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element && element.value.trim()) {
            completedFields++;
        }
    });
    
    const progress = (completedFields / requiredFields.length) * 100;
    
    // Emit progress event
    eventBus.emit('formProgressChanged', {
        progress: progress,
        completedFields: completedFields,
        totalFields: requiredFields.length
    });
    
    return { progress, completedFields, totalFields: requiredFields.length };
}

// ========================================
// FORM AUTO-SAVE
// ========================================

// Automatick√© ukl√°d√°n√≠ formul√°≈ôe do localStorage
function setupAutoSaveEnhanced() {
    console.log('üíæ Setting up enhanced auto-save...');
    
    const formElements = document.querySelectorAll('input, select, textarea');
    
    const debouncedSave = debounce(() => {
        saveFormToLocalStorageEnhanced();
    }, 3000);
    
    formElements.forEach(element => {
        element.addEventListener('input', debouncedSave);
        element.addEventListener('change', debouncedSave);
    });
    
    // Naƒçten√≠ p≈ôi startu
    loadFormFromLocalStorageEnhanced();
}

// Ulo≈æen√≠ formul√°≈ôe do localStorage
function saveFormToLocalStorageEnhanced() {
    try {
        const formData = gatherFormData();
        const saveData = {
            formData: formData,
            timestamp: Date.now(),
            url: window.location.href,
            version: '3b'
        };
        
        localStorage.setItem('donuland_form_autosave', JSON.stringify(saveData));
        console.log('üíæ Enhanced form auto-saved');
        
    } catch (error) {
        console.error('‚ùå Enhanced auto-save failed:', error);
    }
}

// Naƒçten√≠ formul√°≈ôe z localStorage
function loadFormFromLocalStorageEnhanced() {
    try {
        const saved = localStorage.getItem('donuland_form_autosave');
        if (!saved) return;
        
        const saveData = JSON.parse(saved);
        const age = Date.now() - saveData.timestamp;
        
        // Naƒç√≠st pouze pokud je mlad≈°√≠ ne≈æ 24 hodin
        if (age > 24 * 60 * 60 * 1000) {
            localStorage.removeItem('donuland_form_autosave');
            return;
        }
        
        const formData = saveData.formData;
        let fieldsRestored = 0;
        
        // Naƒçten√≠ dat do formul√°≈ôe (pouze pokud jsou pole pr√°zdn√°)
        Object.keys(formData).forEach(key => {
            const element = document.getElementById(key);
            if (element && !element.value && formData[key]) {
                element.value = formData[key];
                fieldsRestored++;
            }
        });
        
        if (fieldsRestored > 0) {
            console.log(`üì• Form data restored: ${fieldsRestored} fields`);
            showNotification(`üì• Obnoveno ${fieldsRestored} pol√≠ z auto-save`, 'info', 3000);
        }
        
    } catch (error) {
        console.error('‚ùå Enhanced auto-load failed:', error);
        localStorage.removeItem('donuland_form_autosave');
    }
}

// ========================================
// PREDICTION TRIGGER OPTIMIZATION
// ========================================

// Optimalizovan√Ω trigger pro predikci
function updatePredictionTriggerEnhanced() {
    // Debounced predikce - spust√≠ se a≈æ po dokonƒçen√≠ psan√≠
    if (globalState.predictionTimeoutEnhanced) {
        clearTimeout(globalState.predictionTimeoutEnhanced);
    }
    
    globalState.predictionTimeoutEnhanced = setTimeout(() => {
        // Pou≈æ√≠t p≈Øvodn√≠ validaci pro kompatibilitu
        const validation = validateRequiredFields();
        
        if (validation.valid) {
            // Aktualizace field status pro UI
            updateFieldsStatus();
            
            // Emit event pro predikci
            eventBus.emit('formValidAndReady');
            
            // Pokud nejsou spu≈°tƒõny jin√© operace, spustit predikci
            if (!globalState.isLoadingPrediction && !globalState.isLoadingWeather) {
                eventBus.emit('triggerPrediction');
            }
        } else {
            // Form nen√≠ validn√≠, zobrazit placeholder
            updateFieldsStatus();
            eventBus.emit('formNotValid', validation.errors);
        }
        
        // Aktualizace progress
        updateFormProgressEnhanced();
        
    }, 700); // 700ms delay pro lep≈°√≠ UX
}

// ========================================
// EVENT LISTENERS PRO PART 3B (OPRAVENO)
// ========================================

// Event listeners pro enhanced validation
eventBus.on('formValidAndReady', () => {
    console.log('‚úÖ Enhanced form is valid and ready for prediction');
});

eventBus.on('formNotValid', (errors) => {
    console.log('‚ùå Enhanced form validation failed:', errors);
    displayPredictionPlaceholder();
});

// Event pro zmƒõnu formul√°≈ôe s enhanced funkcemi
eventBus.on('formChanged', (formData) => {
    console.log('üìù Enhanced form changed handler');
    updateFormProgressEnhanced();
});

// Event pro progress zmƒõnu
eventBus.on('formProgressChanged', (data) => {
    console.log(`üìä Enhanced form progress: ${data.progress.toFixed(1)}%`);
});

// ========================================
// INICIALIZACE PART 3B
// ========================================

// Inicializace p≈ôi naƒçten√≠ str√°nky
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìù Initializing Part 3B Enhanced Features...');
    
    // Mal√© zpo≈ædƒõn√≠ pro zaji≈°tƒõn√≠ naƒçten√≠ p≈ôedchoz√≠ch ƒç√°st√≠
    setTimeout(() => {
        // Nastaven√≠ enhanced validation
        setupRealTimeValidation();
        
        // Nastaven√≠ smart suggestions
        setupSmartSuggestions();
        
        // Nastaven√≠ auto-save
        setupAutoSaveEnhanced();
        
        // Prvn√≠ progress update
        updateFormProgressEnhanced();
        
        console.log('‚úÖ Part 3B Enhanced Features initialized');
    }, 500);
});

// ========================================
// FINALIZACE PART 3B
// ========================================

console.log('‚úÖ Donuland Part 3B (Fixed) loaded successfully');
console.log('üìù Features: ‚úÖ Enhanced Validation ‚úÖ Real-time Feedback ‚úÖ Smart Suggestions ‚úÖ Auto-save');
console.log('üß† Smart features: Auto-categorization + City suggestions + Smart defaults');
console.log('‚ö° Real-time: Field validation + Progress tracking + Debounced prediction trigger');
console.log('üîß Fixed: No conflicts with Part 1&2, preserved Google Maps autocomplete');
console.log('‚è≥ Ready for Part 4: Calendar & Analytics');

// Event pro signalizaci dokonƒçen√≠ ƒç√°sti 3B
eventBus.emit('part3bLoaded', { 
    timestamp: Date.now(),
    version: '1.1.0',
    features: ['enhanced-validation', 'real-time-feedback', 'smart-suggestions', 'auto-save', 'progress-tracking', 'conflict-free']
});
